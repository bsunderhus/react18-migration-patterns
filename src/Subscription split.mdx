# id: subscription-split

- Problem: Subscribe and unsubscribe logic should be colocated to ensure they are always in sync.
- Solution: Place both subscribe and unsubscribe logic within the same function, to force contract. If a function creates a subscription and is not able to clean it up, it should return access to the subscription to the caller so they can handle cleanup.
- Why: React concurrent mode can execute code in a component's render path then throw away the result without ever calling effect hooks, leading to subscriptions that are never cleaned up as their references are lost.

### Anti-pattern: callback subscribes without returning subscription

❌ Issue - The subscribe/unsubscribe are split between the callback and the effect hook which will get out of sync in concurrent mode.

```tsx
const subscriptionRef = React.useRef<Subscription | null>(null);
const subscribeSomewhere = React.useCallback(() => {
  subscriptionRef.current = someService.subscribe((data) => {
    // ...
  });
}, []);
React.useEffect(() => {
  return () => subscriptionRef.current?.unsubscribe();
}, []);
```

✅ Solution - Have the callback return the subscription so the effect hook can clean it up.

```tsx
const subscribeSomewhere = React.useCallback(() => {
  return someService.subscribe((data) => {
    // ...
  });
}, []);

React.useEffect(() => {
  const subscription = subscribeSomewhere();
  return () => subscription.unsubscribe();
}, [subscribeSomewhere]);
```
